<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mic â†’ STT â†’ Agent â†’ TTS</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    #logs {
      height: 360px;
      border: 1px solid #ddd;
      padding: 8px;
      overflow: auto;
      white-space: pre-wrap;
    }
    button { margin-right: 8px; }
  </style>
</head>

<body>
  <h2>Mic â†’ STT â†’ Agent â†’ TTS (WebSocket)</h2>

  <button id="start">Start Capture</button>
  <button id="stop" disabled>Stop & Send</button>

  <div id="logs"></div>

<script>
/* -----------------------------
    Logging helper
------------------------------ */
const logEl = document.getElementById("logs");
const L = (s) => {
  logEl.innerText =
    new Date().toISOString() + " â€” " + s + "\n\n" + logEl.innerText;
  console.log(s);
};

/* -----------------------------
    AudioContext (CRITICAL)
------------------------------ */
let audioCtx = null;

function ensureAudioContext() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    console.log("AudioContext created");
  }

  console.log("AudioContext state BEFORE:", audioCtx.state);

  if (audioCtx.state === "suspended") {
    audioCtx.resume().then(() => {
      console.log("AudioContext resumed");
    });
  }

  console.log("AudioContext state AFTER:", audioCtx.state);
}

/* -----------------------------
   TTS playback via Web Audio API
------------------------------ */
let ttsChunks = [];
let ttsWs = null;

async function playTTS() {
  if (!audioCtx || ttsChunks.length === 0) return;

  const blob = new Blob(ttsChunks, { type: "audio/wav" });
  const arrayBuffer = await blob.arrayBuffer();
  const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

  const source = audioCtx.createBufferSource();
  source.buffer = audioBuffer;
  source.connect(audioCtx.destination);
  source.start(0);

  ttsChunks = [];
}

/* -----------------------------
    Mic capture
------------------------------ */
let mediaRecorder = null;
let chunks = [];

document.getElementById("start").onclick = async () => {
  try {
    ensureAudioContext(); // ðŸ‘ˆ unlocks browser audio

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    L("Got mic stream");

    chunks = [];
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = (ev) => {
      if (ev.data && ev.data.size > 0) {
        chunks.push(ev.data);
      }
    };

    mediaRecorder.onstart = () => L("MediaRecorder started");
    mediaRecorder.start(1000);

    document.getElementById("start").disabled = true;
    document.getElementById("stop").disabled = false;
  } catch (e) {
    L("Error getting mic: " + e);
  }
};

/* -----------------------------
    Stop â†’ upload â†’ agent â†’ TTS
------------------------------ */
document.getElementById("stop").onclick = async () => {
  if (mediaRecorder && mediaRecorder.state !== "inactive") {
    mediaRecorder.stop();
  }

  const blob = new Blob(chunks, { type: chunks[0]?.type || "audio/webm" });
  L("Final blob size: " + blob.size);

  const fd = new FormData();
  fd.append("file", blob, "mic_recording.webm");

  L("Uploading combined blob to /stt/file ...");

  try {
    const resp = await fetch("http://localhost:8000/stt/file", {
      method: "POST",
      body: fd,
    });

    const j = await resp.json();
    L("TRANSCRIPT: " + JSON.stringify(j));

    /* ---- Agent WebSocket ---- */
    ttsWs = new WebSocket("ws://localhost:8000/ws/agent");
    ttsWs.binaryType = "arraybuffer";
    ttsChunks = [];

    ttsWs.onopen = () => {
      L("Agent WS opened");
      ttsWs.send(JSON.stringify({
        transcript: j.text || j.transcript || "",
        session_id: "demo-session"
      }));
    };

    ttsWs.onmessage = (event) => {
      if (event.data instanceof ArrayBuffer) {
        console.log("Audio chunk:", event.data.byteLength);
        ttsChunks.push(event.data);
      } else {
        const msg = JSON.parse(event.data);
        if (msg.type === "audio_end") {
          playTTS();
        }
      }
    };

  } catch (e) {
    L("Upload error: " + e);
  }

  document.getElementById("start").disabled = false;
  document.getElementById("stop").disabled = true;
};
</script>
</body>
</html>
